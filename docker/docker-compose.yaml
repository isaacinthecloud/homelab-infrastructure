version: "3.9"

networks:
  traefik-net:
    name: traefik-net
    driver: bridge

services:

  # ===========================================
  # TRAEFIK - Reverse Proxy with SSL
  # ===========================================
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - traefik-net
    ports:
      - 80:80
      - 443:443
    environment:
      - AWS_ACCESS_KEY_ID=your_aws_key
      - AWS_SECRET_ACCESS_KEY=your_aws_secret
      - AWS_REGION=your_region
      - AWS_HOSTED_ZONE_ID=your_zone_id
    volumes:
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/acme:/acme
      - ./traefik/logs:/var/log/traefik
      - ./traefik/dynamic:/dynamic:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
    labels:
      - "traefik.enable=true"
      # Dashboard
      - "traefik.http.routers.traefik.rule=Host(`traefik.example.lab`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.middlewares=traefik-auth"
      # Basic Auth
      - "traefik.http.middlewares.traefik-auth.basicauth.users=admin:hashedpassword"

  # ===========================================
  # PORTAINER - Container Management
  # ===========================================
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - traefik-net
    volumes:
      - ./portainer:/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`portainer.example.lab`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls.certresolver=letsencrypt"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"

  # ===========================================
  # GLUETUN - VPN Container
  # ===========================================
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      - traefik-net
    ports:
      - 6881:6881
      - 6881:6881/udp
    environment:
      - VPN_SERVICE_PROVIDER=nordvpn
      - VPN_TYPE=openvpn
      - OPENVPN_USER=your_vpn_user
      - OPENVPN_PASSWORD=your_vpn_password
      - SERVER_COUNTRIES=Netherlands
      - TZ=Etc/UTC
    restart: unless-stopped

  # ===========================================
  # RADARR
  # ===========================================
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    network_mode: "service:gluetun"
    environment:
      - PUID=0
      - PGID=0
      - TZ=Etc/UTC
    volumes:
      - ./radarr/config:/config
      - ./movies:/movies
      - ./downloads/complete:/downloads
    restart: unless-stopped
    depends_on:
      - gluetun

  # ===========================================
  # SONARR
  # ===========================================
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    network_mode: "service:gluetun"
    environment:
      - PUID=0
      - PGID=0
      - TZ=Etc/UTC
    volumes:
      - ./sonarr/config:/config
      - ./tv:/tv
      - ./downloads/complete:/downloads
    restart: unless-stopped
    depends_on:
      - gluetun

  # ===========================================
  # PROWLARR
  # ===========================================
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    network_mode: "service:gluetun"
    environment:
      - PUID=0
      - PGID=0
      - TZ=Etc/UTC
    volumes:
      - ./prowlarr/config:/config
    restart: unless-stopped
    depends_on:
      - gluetun

  # ===========================================
  # BAZARR
  # ===========================================
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    network_mode: "service:gluetun"
    environment:
      - PUID=0
      - PGID=0
      - TZ=Etc/UTC
    volumes:
      - ./bazarr/config:/config
      - ./movies:/movies
      - ./tv:/tv
    restart: unless-stopped
    depends_on:
      - gluetun

  # ===========================================
  # LIDARR
  # ===========================================
  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    network_mode: "service:gluetun"
    environment:
      - PUID=0
      - PGID=0
      - TZ=Etc/UTC
    volumes:
      - ./lidarr/config:/config
      - ./music:/music
      - ./downloads/complete:/downloads
    restart: unless-stopped
    depends_on:
      - gluetun

  # ===========================================
  # QBITTORRENT
  # ===========================================
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:gluetun"
    environment:
      - PUID=0
      - PGID=0
      - TZ=Etc/UTC
      - WEBUI_PORT=8080
      - TORRENTING_PORT=6881
    volumes:
      - ./qbittorrent/config:/config
      - ./downloads/incomplete:/downloads/incomplete
      - ./downloads/complete:/downloads/complete
    restart: unless-stopped
    depends_on:
      - gluetun

  # ===========================================
  # JELLYFIN
  # ===========================================
  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    networks:
      - traefik-net
    environment:
      - PUID=0
      - PGID=0
      - TZ=Etc/UTC
    volumes:
      - ./jellyfin/config:/config
      - ./tv:/data/tvshows
      - ./movies:/data/movies
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`media.example.lab`)"
      - "traefik.http.routers.jellyfin.entrypoints=websecure"
      - "traefik.http.routers.jellyfin.tls.certresolver=letsencrypt"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
